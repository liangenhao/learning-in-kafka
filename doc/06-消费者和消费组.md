---
title: 06-消费者和消费组
date: 2019-11-09
categories: learning-in-kafka
tags: [Kafka]
---



## 消费者与消费组

### 基本概念

- 消费者负责订阅主题，并从订阅的主题上**拉取**消息。

- 每个消费者都有一个对应的消费组。

- 当消息发布到主题后，**只会被投递给订阅它的每个消费者组中的一个消费者**。

  > 这样就避免了同一个消费组里的消费者重复消费同一条消息的情况。
  >
  > 但不同消费组里的消费者可以消费同一条消息。

- 消费组是<u>**逻辑上**</u>的概念，它将旗下的消费者归为一类，**每个消费者只隶属于一个消费组。**

- 每个消费组都有一个固定的名称，消费者在进行消费前需要制定其所属消费组的名称，可以通过消费者客户端参数`group.id`来配置，默认为空字符串。

- 消费者并非逻辑上的概念，它是实际的应用实例，它可以是一个线程，也可以是一个进程。同一个消费组内的消费者既可以部署在同一个机器上，也可以部署在不同的机器上。

### 消费者与分区分配

![消费者和消费组](/Users/enhao/Documents/projects/GitHub/learning-in-kafka/doc/images/%E6%B6%88%E8%B4%B9%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E7%BB%84.png)

【前提】：

- 某个主题有四个分区（P0～P3）。
- 有两个消费组A和B都订阅这个主题。消费组A有四个消费者（C0～C3），消费组B有两个消费者（C4、C5）。

【分配规则】：

- 消费组A中的每个消费者分配到一个分区。
- 消费组B中的每个消费者分配到2个分区。

【总结】：

- **每个分区只能被每个消费组中的一个消费者所消费。**

  > 避免重复消费。

### 分区分配策略

【前提】：

- 某个主题有7个分区（P0~P6）。
- 某个消费组订阅这个主题，只有一个消费者C0。

【分配规则】：

- 消费者C0订阅了7个分区。
- ![消费组内只有一个消费者](/Users/enhao/Documents/projects/GitHub/learning-in-kafka/doc/images/%E6%B6%88%E8%B4%B9%E7%BB%84%E5%86%85%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E6%B6%88%E8%B4%B9%E8%80%85.png)

【前提变化1】：

- 此时消费组内新加入一个消费者C1。

【分配规则】：

- 需要将原来消费者C0的部分分区分配给消费者C1消费。
- ![消费组有两个消费者.png](/Users/enhao/Documents/projects/GitHub/learning-in-kafka/doc/images/%E6%B6%88%E8%B4%B9%E7%BB%84%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%B6%88%E8%B4%B9%E8%80%85.png)

【前提变化2】：

- 再加入一个消费者C2。

【分配规则】：

- ![消费组内有三个消费者](/Users/enhao/Documents/projects/GitHub/learning-in-kafka/doc/images/%E6%B6%88%E8%B4%B9%E7%BB%84%E5%86%85%E6%9C%89%E4%B8%89%E4%B8%AA%E6%B6%88%E8%B4%B9%E8%80%85.png)

【前提变化3】：

- 消费组内的消费者超过分区数。

【分配规则】：

- 超出的消费者无法进行消费。
- ![消费组内有过多的消费者](/Users/enhao/Documents/projects/GitHub/learning-in-kafka/doc/images/%E6%B6%88%E8%B4%B9%E7%BB%84%E5%86%85%E6%9C%89%E8%BF%87%E5%A4%9A%E7%9A%84%E6%B6%88%E8%B4%B9%E8%80%85.png)

【总结】：

- 消费者和消费组模型让整体的消费能力具备**横向伸缩性**。

- 对于分区数固定的情况，一味地增加消费者并不会让消费能力一致得到提升。

- **若出现了消费者的个数大于分区个数的情况，就会有消费者分配不到任何分区。**

- 以上分配逻辑是基于默认的分区分配策略的，可以通过消费者客户端参数`partition.assignment.strategy`来设置消费者与订阅主题之间的分区分配策略。

  > 分区分配策略详见书7.1节。



## 消息投递模式

### 点对点模式

【定义】：基于队列，消息生产者发送消息到队列，消息消费者从队列中接受消息。

### 发布订阅模式

【定义】：定义了如何向一个内容节点发布和订阅消息，这个内容节点成为主题（topic），主题可以认为是消息传递的中介，消息发布者将消息发布到某个主题，而消息订阅者从主题中订阅消息。主题使得消息的订阅者和发布者互相保持独立。发布订阅模式在消息的一对多广播时采用。

### kafka是如何支持这两种模式的

得益于消费者和消费组模型的契合：

- 若**<u>所有的消费者都隶属于同一个消费组</u>**，那么所有的消息都会被均衡地投递给每一个消费者，即每条消息只会被一个消费者处理，这就**<u>相当于点对点模式</u>**的应用。
- 若**所有的消费者都隶属于不同的消费组**，那么所有的消息都会被广播给所有的消费者，即每条消息都会被所有的消费者处理，这就**<u>相当于发布/订阅模式</u>**的应用。

